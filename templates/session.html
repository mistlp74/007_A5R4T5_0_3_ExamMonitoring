<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–°–µ—Å—ñ—è {{ session_code }}</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial; margin: 20px; }
        #messages { border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        #chat-form { display: flex; gap: 10px; margin-bottom: 20px; }
        #videos { display: flex; flex-wrap: wrap; gap: 10px; }
        .video-container { display: flex; flex-direction: column; align-items: center; }
        .video-container img, .video-container video { width: 240px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h2>–°–µ—Å—ñ—è: {{ session_code }}</h2>
    <p>–í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ <strong>{{ role }}</strong>: {{ name }}</p>

    <div id="messages"></div>

    <form id="chat-form" onsubmit="sendMessage(); return false;">
        <select id="recipient">
            {% for p in participants %}
                {% if role == 'teacher' or (role == 'student' and p.role == 'teacher') %}
                    {% if p.name != name %}
                        <option value="{{ p.name }}">{{ p.name }} ({{ p.role }})</option>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </select>
        <input type="text" id="message" placeholder="–í–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è" required>
        <button type="submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
    </form>

    <!-- üßç –¶–ï –í–Ü–î–ï–û –£–ß–ù–Ø: –≤—Å—Ç–∞–≤ —Ç—É—Ç -->
    {% if role == 'student' %}
        <video id="video" autoplay muted playsinline style="border: 2px solid #ccc; width: 240px; margin-bottom: 10px;"></video>
        <canvas id="canvas" style="display:none;"></canvas> <!-- –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ canvas –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∫–∞–¥—Ä—ñ–≤ -->

    {% endif %}

    <!-- –í—ñ–¥–µ–æ –≤—Å—ñ—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤ —É –≤—á–∏—Ç–µ–ª—è -->
    <div id="videos"></div>

    <script>
        const socket = io();
        const name = "{{ name }}";
        const role = "{{ role }}";
        const sessionCode = "{{ session_code }}";

        socket.emit('join', { session_code: sessionCode, name: name });

        function sendMessage() {
            const recipient = document.getElementById('recipient').value;
            const message = document.getElementById('message').value;
            socket.emit('send_message', {
                session_code: sessionCode,
                sender: name,
                recipient: recipient,
                message: message
            });
            addMessage(`(–í–∏ –¥–æ ${recipient}): ${message}`);
            document.getElementById('message').value = '';
        }

        socket.on('receive_message', function(data) {
            addMessage(`${data.sender}: ${data.message}`);
        });

        function addMessage(text) {
            const container = document.getElementById('messages');
            const p = document.createElement('p');
            p.textContent = text;
            container.appendChild(p);
            container.scrollTop = container.scrollHeight;
        }

        // üì∏ STUDENT: capture and send frames
        if (role === 'student') {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;

            video.onloadedmetadata = () => {
                video.play();

                setInterval(() => {
                    // –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –≤—ñ–¥–µ–æ –º–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ –ø–µ—Ä–µ–¥ –º–∞–ª—é–≤–∞–Ω–Ω—è–º
                    if (video.videoWidth && video.videoHeight) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = canvas.toDataURL('image/jpeg', 0.6);

                        // –õ–æ–≥ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏, —á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è –∫–∞–¥—Ä–∏
                        console.log("Sending frame:", imageData);

                        socket.emit('video_frame', {
                            session_code: sessionCode,
                            sender: name,
                            frame: imageData
                        });
                    }
                }, 500); // –∫–æ–∂–Ω—ñ 500 –º—Å
            };
        })
        .catch(err => {
            console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏:", err);
        });
}



        // üëÄ TEACHER: receive and show student frames
        if (role === 'teacher') {
    socket.on('receive_frame', data => {
        const id = `student-${data.sender}`;
        let container = document.getElementById(id);
        if (!container) {
            container = document.createElement('div');
            container.className = 'video-container';
            container.id = id;
            container.innerHTML = `<strong>${data.sender}</strong><video autoplay muted playsinline></video>`;
            document.getElementById('videos').appendChild(container);
        }
        const video = container.querySelector('video');

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —î –∫–∞–¥—Ä–∏ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        if (data.frame) {
            const img = new Image();
            img.onload = () => {
                video.src = img.src; // –¢—Ä–∞–Ω—Å–ª—é—î–º–æ –≤—ñ–¥–µ–æ —á–µ—Ä–µ–∑ <video> —Ç–µ–≥
            };
            img.src = data.frame;
        } else {
            console.error("No frame data received!");
        }
    });
}


    </script>
</body>
</html>
